

-- Estrazione della data da Anno-Settimana

  cast(DATEADD(wk, DATEDIFF(wk, 7, CAST(tab.[Anno] AS NVARCHAR(100))) + (tab.[settimana]-1), 7) as date) as [Date]


-- Rimozione duplicati

DELETE 
FROM MyTable
LEFT OUTER JOIN (
                  SELECT MIN(RowId) as RowId, Col1, Col2, Col3 
                  FROM MyTable 
                  GROUP BY Col1, Col2, Col3
                ) as KeepRows 
                ON MyTable.RowId = KeepRows.RowId
WHERE
  KeepRows.RowId IS NULL


-- Check Status Shrink

SELECT 
   percent_complete
  ,start_time, status
  ,command
  ,estimated_completion_time
  ,cpu_time
  ,total_elapsed_time 
FROM sys.dm_exec_requests 


-- Check Table Lock

SELECT *  
FROM sys.dm_exec_requests 
WHERE 
  DB_NAME(database_id) = 'DB_NAME'  -- Sostituire con il nome del DB da controllare
  AND blocking_session_id <> 0 


-- 
--  Tronca tabelle per schema
--

create procedure [dbo].[Test_Tronca_Tabelle_per_Schema]
as

declare @query_count varchar(max)
declare @query_truncate varchar(max)

declare @tmp_table_name varchar(max)


declare cur cursor for
SELECT TABLE_CATALOG + '.' + TABLE_SCHEMA + '.' + TABLE_NAME as tabella
FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_TYPE = 'BASE TABLE' AND TABLE_schema='ax'



Open cur     
 
Fetch Next From cur Into @tmp_table_name
 
While (@@FETCH_STATUS = 0)
begin
	set @query_truncate = 'truncate table ' + @tmp_table_name
	exec @query_truncate
 
	Fetch Next From cur Into @tmp_table_name
 
end 


Close cur
Deallocate cur
 
GO


--------------------------------------------------------------------
SPAZIO OCCUPATO TABELLE

SELECT

t.NAME AS TableName,

s.Name AS SchemaName,

p.rows AS RowCounts,

SUM(a.total_pages) * 8 / 1024 AS TotalSpaceMB,

SUM(a.used_pages) * 8 / 1024 AS UsedSpaceMB,

(SUM(a.total_pages) - SUM(a.used_pages)) * 8 / 1024 AS UnusedSpaceMB

FROM

sys.tables t

INNER JOIN

sys.indexes i ON t.OBJECT_ID = i.object_id

INNER JOIN

sys.partitions p ON i.object_id = p.OBJECT_ID AND i.index_id = p.index_id

INNER JOIN

sys.allocation_units a ON p.partition_id = a.container_id

LEFT OUTER JOIN

sys.schemas s ON t.schema_id = s.schema_id

WHERE

t.NAME NOT LIKE 'dt%'

AND t.is_ms_shipped = 0

AND i.OBJECT_ID > 255

GROUP BY

t.Name, s.Name, p.Rows

ORDER BY

SUM(a.total_pages) desc


